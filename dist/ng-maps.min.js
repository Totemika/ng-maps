angular.module("ngMaps",[]),angular.module("ngMaps").factory("MapObjects",function(){var API={};return API.closest=function(coords1,data){var closest;return angular.forEach(data,function(feature){var coords2=feature.getGeometry().get(),distance=google.maps.geometry.spherical.computeDistanceBetween(coords1,coords2);(!closest||closest.distance>distance)&&(closest={marker:feature,distance:distance})}),closest.marker},API.map=null,API}),angular.module("ngMaps").directive("circles",["MapObjects",function(MapObjects){return{restrict:"E",scope:{geometries:"=",events:"=",visible:"=",options:"="},require:"^map",link:function($scope,$element,$attrs,parent){$scope.$watch(function(){parent.getMap()},function(){var map=parent.getMap(),circleList=[];$scope.$watch("visible",function(){angular.forEach(circleList,function(c){c.setVisible($scope.visible)})}),$scope.$watch("options",function(){angular.forEach(circleList,function(c){c.setOptions(options)})}),$scope.$watch("geometries",function(){newData()}),newData=function(){angular.forEach(circleList,function(c){c.setMap(null)}),circleList=[],angular.forEach($scope.geometries,function(c){var opts=$scope.options?$scope.options:{};opts.center=new google.maps.LatLng(c.center[0],c.center[1]),opts.radius=c.radius,opts.map=map;var circle=new google.maps.Circle(opts);circleList.push(circle),angular.forEach($scope.events,function(val,key){google.maps.event.addListener(circle,key,function(e){val(e,this,MapObjects)})})})}})}}}]),angular.module("ngMaps").directive("control",function(){return{restrict:"E",scope:{position:"@",visible:"="},require:"^map",link:function($scope,$element,$attrs,parent){$scope.$watch(function(){parent.getMap()},function(){var map=parent.getMap(),position=$scope.position.split(/(?=[A-Z])/).join("_").toUpperCase();$scope.$watch(function(){return $element[0].innerHTML},function(){var controlDiv=document.createElement("div");map.controls[google.maps.ControlPosition[position]].pop(),$scope.visible!==!1&&(controlDiv.innerHTML=$element[0].innerHTML),map.controls[google.maps.ControlPosition[position]].push(controlDiv)})})}}}),angular.module("ngMaps").directive("geopoints",["MapObjects","$http",function(MapObjects,$http){return{restrict:"E",scope:{url:"=",events:"=",options:"=",visible:"="},require:"^map",link:function($scope,$element,$attrs,parent){$scope.$watch(function(){parent.getMap()},function(){var map=parent.getMap(),markers=[];$scope.$watch(function(){return $scope.options},function(){angular.forEach(markers,function(marker){marker.setOptions($scope.options(marker,MapObjects))})}),$scope.$watch(function(){return $scope.visible},function(){angular.forEach(markers,function(marker){marker.setVisible($scope.visible)})}),$scope.$watch(function(){return $scope.url},function(){newData($scope.url)});var newData=function(url){$http.get(url).success(function(data){angular.forEach(markers,function(m){m.setMap(null)}),markers=[],angular.forEach(data.features,function(m){var opts=$scope.options?$scope.options(m,MapObjects):function(){return{}};opts.position=new google.maps.LatLng(m.geometry.coordinates[1],m.geometry.coordinates[0]),opts.visible=$scope.visible,opts.map=map;var marker=new google.maps.Marker(opts);marker.properties=m.properties,marker.geometry=m.geometry,marker.getProperty=function(p){return this.properties[p]},markers.push(marker),angular.forEach($scope.events,function(val,key){google.maps.event.addListener(marker,key,function(e){val(e,marker,MapObjects,markers)})})})})}})}}}]),angular.module("ngMaps").directive("geopolygons",["MapObjects","$http",function(MapObjects,$http){return{restrict:"E",scope:{url:"=",events:"=",options:"=",visible:"=",opacity:"="},require:"^map",link:function($scope,$element,$attrs,parent){$scope.$watch(function(){parent.getMap()},function(){var map=parent.getMap(),polygons=[];$scope.$watch(function(){return $scope.options},function(){angular.forEach(polygons,function(p){var opts=$scope.options?$scope.options(p,MapObjects):{};opts.fillOpacity=$scope.opacity?$scope.opacity/100:1,p.setOptions(opts)})}),$scope.$watch(function(){return $scope.opacity},function(){angular.forEach(polygons,function(p){p.setOptions({fillOpacity:$scope.opacity/100})})}),$scope.$watch(function(){return $scope.visible},function(){angular.forEach(polygons,function(p){p.setVisible($scope.visible)})}),$scope.$watch(function(){return $scope.url},function(){newData($scope.url)});var newData=function(url){$http.get(url).success(function(data){angular.forEach(polygons,function(p){p.setMap(null)}),polygons=[],angular.forEach(data.features,function(p){for(var j=0;j<p.geometry.coordinates.length;j++)for(var coords=p.geometry.coordinates[j],k=0;k<coords.length;k++)coords[k]=new google.maps.LatLng(coords[k][1],coords[k][0]);var polygon=new google.maps.Polygon({paths:p.geometry.coordinates}),opts=$scope.options?$scope.options(p,MapObjects):{};opts.fillOpacity=$scope.opacity?$scope.opacity/100:1,polygon.setOptions(opts),polygon.setMap(map),polygon.properties=p.properties,polygon.geometry=p.geometry,polygon.getProperty=function(p){return this.properties[p]},polygons.push(polygon),angular.forEach($scope.events,function(val,key){google.maps.event.addListener(polygon,key,function(e){val(e,this,MapObjects)})})})})}})}}}]),angular.module("ngMaps").directive("infowindow",function(){return{restrict:"E",scope:{position:"="},require:"^map",compile:function(){return function($scope,$element,$attrs,parent){$scope.$watch(function(){parent.getMap()},function(){var map=parent.getMap(),infowindow=new google.maps.InfoWindow({content:null,position:null});$scope.$watch(function(){return $element[0].innerHTML+$scope.position},function(){infowindow.setContent($element[0].innerHTML),infowindow.setPosition($scope.position),infowindow.open(map)})})}}}}),angular.module("ngMaps").directive("map",["MapObjects",function(MapObjects){return{restrict:"AE",scope:{center:"=",zoom:"=",events:"=",options:"="},controller:function($scope){this.getMap=function(){return $scope.map}},transclude:!0,link:function($scope,elem){var events=$scope.events,center=$scope.center,options=$scope.options?$scope.options:{},latitude=center?center[0]:47.6,longitude=center?center[1]:-122.3;options.center=new google.maps.LatLng(latitude,longitude),options.zoom=$scope.zoom?$scope.zoom:8;var map=new google.maps.Map(elem[0],options);angular.forEach(events,function(val,key){google.maps.event.addListener(map,key,function(e){val(e,MapObjects)})}),$scope.map=map}}}]),angular.module("ngMaps").directive("marker",["MapObjects",function(MapObjects){return{restrict:"E",scope:{options:"=",events:"=",position:"=",lat:"=",lng:"=",decimals:"="},require:"^map",link:function($scope,$element,$attrs,parent){$scope.$watch(function(){parent.getMap()},function(){var map=parent.getMap(),decimals=$scope.decimals,events=$scope.events?$scope.events:{},options=$scope.options?$scope.options:{},round=function(val){return decimals||0===decimals?Math.round(Math.pow(10,decimals)*val)/Math.pow(10,decimals):val},curPosition=function(){return $scope.position?new google.maps.LatLng($scope.position[0],$scope.position[1]):$scope.lat&&$scope.lng?new google.maps.LatLng($scope.lat,$scope.lng):void 0};options.position=curPosition(),options.map=map;var marker=new google.maps.Marker(options);angular.forEach(events,function(val,key){google.maps.event.addListener(marker,key,function(e){val(e,MapObjects)})}),$scope.$watch("[position, lat, lng]",function(){marker.setPosition(curPosition())},!0),google.maps.event.addListener(marker,"drag",function(){$scope.$apply(function(){var lat=round(marker.getPosition().lat()),lng=round(marker.getPosition().lng());$scope.position?$scope.position=[lat,lng]:$scope.lat&&$scope.lng&&($scope.lat=lat,$scope.lng=lng)})})})}}}]),angular.module("ngMaps").directive("overlay",["MapObjects",function(){return{restrict:"E",scope:{url:"=",opacity:"=",bounds:"=",visible:"="},require:"^map",link:function($scope,$element,$attrs,parent){$scope.$watch(function(){parent.getMap()},function(){function isFloat(n){return n===+n&&n!==(n||0)}var map=parent.getMap(),parseOpacity=function(){return isFloat($scope.opacity)?$scope.opacity:parseFloat($scope.opacity)},deleteOverlay=function(){overlay&&(overlay.setMap(null),overlay=null)},newOverlay=function(){deleteOverlay();var overlay=new google.maps.GroundOverlay($scope.url,$scope.bounds,{clickable:!1});return overlay.setOpacity(parseOpacity()/100),overlay.setMap($scope.visible!==!1?map:null),overlay},overlay=newOverlay();$scope.$watch("url + bounds",function(){overlay=newOverlay()}),$scope.$watch("opacity",function(){overlay.setOpacity(parseOpacity()/100)}),$scope.$watch("visible",function(){overlay.setMap($scope.visible!==!1?map:null)})})}}}]),angular.module("ngMaps").directive("points",["MapObjects",function(MapObjects){return{restrict:"E",scope:{coords:"=",options:"=",properties:"=",events:"=",visible:"=",decimals:"="},require:"^map",link:function($scope,$element,$attrs,parent){$scope.$watch(function(){parent.getMap()},function(){var map=parent.getMap(),points=[],round=function(val){return $scope.decimals||0===$scope.decimals?Math.round(Math.pow(10,$scope.decimals)*val)/Math.pow(10,$scope.decimals):val},newCoords=function(coords){angular.forEach(points,function(p){p.setMap(null)}),points=[],angular.forEach(coords,function(c,i){var opts=$scope.options;opts.position=new google.maps.LatLng(c[0],c[1]),opts.map=map;var point=new google.maps.Marker(opts);angular.forEach($scope.events,function(val,key){google.maps.event.addListener(point,key,function(e){val(e,this,MapObjects)})}),google.maps.event.addListener(point,"drag",function(){$scope.$apply(function(){var lat=round(point.getPosition().lat()),lng=round(point.getPosition().lng());$scope.coords[i]=[lat,lng]})}),points.push(point)})};$scope.$watch("coords",function(){newCoords($scope.coords)}),$scope.$watch("visible",function(){angular.forEach(points,function(p){p.setVisible($scope.visible)})})})}}}]),angular.module("ngMaps").directive("polygons",["MapObjects",function(MapObjects){return{restrict:"E",scope:{coords:"=",options:"=",properties:"=",opacity:"=",visible:"="},require:"^map",link:function($scope,$element,$attrs,parent){$scope.$watch(function(){parent.getMap()},function(){var map=parent.getMap(),polygons=[];$scope.$watch(function(){return $scope.options},function(){angular.forEach(polygons,function(p){var opts=$scope.options?$scope.options(p,MapObjects):{};opts.fillOpacity=$scope.opacity?$scope.opacity/100:1,p.setOptions(opts)})}),$scope.$watch(function(){return $scope.opacity},function(){angular.forEach(polygons,function(p){p.setOptions({fillOpacity:$scope.opacity/100})})}),$scope.$watch(function(){return $scope.visible},function(){angular.forEach(polygons,function(p){p.setVisible($scope.visible)})}),$scope.$watch(function(){return $scope.coords},function(){newData($scope.coords)});var newData=function(coords){angular.forEach(polygons,function(p){p.setMap(null)}),polygons=[],angular.forEach(coords,function(c,i){for(var path=[],j=0;j<c.length;j++)for(var k=0;k<c[j].length;k++)console.log(c[j]),path.push(new google.maps.LatLng(c[j][k][0],c[j][k][1]));var polygon=new google.maps.Polygon({paths:path});$scope.properties&&(polygon.properties=$scope.properties[i]),polygon.setMap(map);var opts=$scope.options?$scope.options(polygon,MapObjects):{};opts.fillOpacity=$scope.opacity?$scope.opacity/100:1,polygon.setOptions(opts),polygon.getProperty=function(p){return this.properties[p]},polygons.push(polygon),angular.forEach($scope.events,function(val,key){google.maps.event.addListener(polygon,key,function(e){val(e,this,MapObjects)})})})}})}}}]),angular.module("ngMaps").directive("polylines",["MapObjects",function(){return{restrict:"E",scope:{coords:"=",options:"=",visible:"="},require:"^map",link:function($scope,$element,$attrs,parent){$scope.$watch(function(){parent.getMap()},function(){var map=parent.getMap(),lines=[];$scope.$watch("coords",function(){newData($scope.coords)}),$scope.$watch("visible",function(){angular.forEach(lines,function(l){l.setVisible($scope.visible)})}),$scope.$watch("options",function(){angular.forEach(lines,function(l){l.setOptions($scope.options)})});var newData=function(coords){angular.forEach(lines,function(l){l.setMap(null)}),lines=[],angular.forEach(coords,function(l){var line=[];angular.forEach(l,function(c){line.push(new google.maps.LatLng(c[0],c[1]))});var opts=$scope.options;opts.path=line,opts.map=map;var polyline=new google.maps.Polyline(opts);lines.push(polyline)})}})}}}]),angular.module("ngMaps").directive("rectangles",["MapObjects",function(){return{restrict:"E",scope:{geometries:"=",events:"=",visible:"=",options:"="},require:"^map",link:function($scope,$element,$attrs,parent){$scope.$watch(function(){parent.getMap()},function(){parent.getMap()})}}}]);